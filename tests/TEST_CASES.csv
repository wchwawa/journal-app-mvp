Module,Type,ID,Title,Preconditions,Steps,Expected,Priority
"Module A","Unit","MA-U-001","Local day range handles DST boundaries","System timezone defaults to Australia/Sydney; vitest fast-check harness available","Call getLocalDayRange({ date: new Date('2025-04-06T00:30:00+11:00') }) during DST rollback and capture date/start/end","Date string remains 2025-04-06; start/end bracket the same local day without drifting to 2025-04-05",P0
"Module A","Integration","MA-I-002","Daily mood modal enters update mode when entry exists","Mock Clerk user + Supabase client returning a row with day_quality='good'; jest-dom environment","Render DailyMoodModal, fire open event, change selection to 'bad day', submit","Supabase .update called with existing id, loading states shown, 'moodEntryUpdated' event dispatched",P0
"Module A","Contract","MA-C-003","Transcribe API rejects uploads over 25MB","Next route handler invoked via supertest; mocked OpenAI client; blob factory able to generate >25MB file","POST /api/transcribe with 26MB audio/webm payload and valid cookies","Response 400 JSON { error: 'File too large' }; OpenAI + Supabase mocks untouched",P0
"Module A","Security","MA-S-004","Untrusted origins are blocked for write routes","Construct NextRequest with Host=app.echojournal.dev and Origin=https://evil.site","Invoke POST /api/transcribe (or /api/reflections/sync) with forged Origin","Route returns 403 and body { error: 'Invalid request origin' } before any downstream work",P0
"Module B","Unit","MB-U-001","Weekly period bounds snap to Monday–Sunday","Anchor date string '2025-11-13' (Thursday); timezone config default","Call getPeriodBounds('weekly', '2025-11-13')","start === '2025-11-10' (Mon) and end === '2025-11-16' (Sun); no UTC drift",P0
"Module B","Integration","MB-I-002","generateReflection skips overwriting edited daily cards","Supabase stub returns daily_summaries row with edited=true and manual achievements; OpenAI mock returns new content","Call generateReflection({ mode: 'daily', anchorDate: '2025-11-11' })","Update payload keeps existing achievements/commitments/mood while refreshing stats + last_generated_at",P0
"Module B","Integration","MB-I-003","PATCH /api/reflections/daily rejects lists longer than 3","Authenticated Clerk user; trusted Origin header; Supabase admin mock","Send PATCH /api/reflections/daily/2025-11-11 with 4 achievements","Endpoint responds 422 with zod error message; no DB write",P1
"Module B","E2E","MB-E-004","Daily echo appears after audio submission","Playwright test user with seeded Supabase + mocked OpenAI transcribe success","Complete recorder flow, wait for toast, navigate to /dashboard/echos","First card shows today's date with 'In progress' badge and achievements populated",P1
"Module C","Unit","MC-U-001","search-quota resets each local day","Call helpers directly; ability to mock getLocalDayRange","Invoke canUseSearch + recordSearchUsage five times, then simulate a new day by advancing mocked date","Remaining count never drops below 0; after date change remaining resets to 5",P0
"Module C","Integration","MC-I-002","useVoiceAgent transitions idle→ready on successful connect","Mock navigator.mediaDevices.getUserMedia, fetch('/api/agent/token'), and RealtimeSession class","Render hook, call connect(), await microtasks","State.status becomes 'ready', searchRemaining reset to 5, internal session.mute called with true",P0
"Module C","Contract","MC-C-003","Agent context tool enforces custom range requirement","Authenticated request to /api/agent/tools/context; origin trusted","POST payload { scope: 'custom' } without range field","Response 400 with message 'Custom scope requires range'; Supabase not queried",P1
"Shared","Fuzz","SH-F-001","Origin parser withstands fuzzed inputs","fast-check generator over random protocol/hosts","Generate 10k random Origin/Referer combinations and run isTrustedOrigin","No crashes; only hosts exactly matching request.host evaluate true",P0
